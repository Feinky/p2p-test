<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Titan P2P | Binary Strict</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --p: #1a9fff; --bg: #0b0e14; --card: #1c1c1e; --text: #ffffff; }
        body { font-family: system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .app { width: 100%; max-width: 500px; background: var(--card); border-radius: 15px; padding: 20px; box-shadow: 0 10px 30px #000; }
        .btn { background: var(--p); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 10px; }
        input { width: 100%; padding: 10px; box-sizing: border-box; background: #222; border: 1px solid #444; color: white; border-radius: 8px; }
        .monitor { margin-top: 20px; background: #000; padding: 15px; border-radius: 10px; }
        progress { width: 100%; height: 10px; accent-color: var(--p); }
        .status { font-size: 0.8rem; color: #888; margin-top: 5px; display: flex; justify-content: space-between; }
    </style>
</head>
<body>

<div class="app">
    <h2 style="margin-top:0">Titan Binary Transfer</h2>
    <input type="text" id="room" placeholder="Enter Room Name...">
    <button class="btn" onclick="init()">CONNECT ROOM</button>

    <div id="controls" style="display:none; margin-top:20px;">
        <button class="btn" style="background:#4c6b22" onclick="document.getElementById('file').click()">+ CHOOSE ANY FILE TYPE</button>
        <input type="file" id="file" style="display:none">
        <div id="peerFiles" style="margin-top:15px; border-top: 1px solid #333; padding-top:15px;"></div>
    </div>

    <div id="monitor" class="monitor" style="display:none">
        <div id="fname" style="font-weight:bold; font-size:0.9rem; margin-bottom:10px">Filename</div>
        <progress id="bar" value="0" max="100"></progress>
        <div class="status">
            <span id="mode">Idle</span>
            <span id="perc">0%</span>
        </div>
    </div>
</div>

<script>
    let peer, conn, myFiles = {};
    const CHUNK_SIZE = 16384; // 16KB - Most stable size for WebRTC

    function init() {
        const r = document.getElementById('room').value.trim();
        if (!r) return;
        if (peer) peer.destroy();
        
        peer = new Peer(`TITAN-STRICT-${r}-A`, { config: {'iceServers': [{ 'urls': 'stun:stun.l.google.com:19302' }] }});
        peer.on('error', () => {
            peer = new Peer(`TITAN-STRICT-${r}-B`, { config: {'iceServers': [{ 'urls': 'stun:stun.l.google.com:19302' }] }});
            setup(`TITAN-STRICT-${r}-A`);
        });
        peer.on('open', () => setup(`TITAN-STRICT-${r}-B`));
    }

    function setup(target) {
        document.getElementById('controls').style.display = 'block';
        peer.on('connection', c => handle(c));
        setInterval(() => { if(!conn || !conn.open) handle(peer.connect(target)); }, 3000);
    }

    function handle(c) {
        conn = c;
        conn.on('open', () => { if(Object.keys(myFiles).length > 0) sync(); });
        conn.on('data', async (data) => {
            if (data.type === 'list') renderList(data.files);
            if (data.type === 'req') sendFile(data.name);
            if (data.type === 'meta') receiveFile(data);
        });
    }

    document.getElementById('file').onchange = (e) => {
        for (let f of e.target.files) { myFiles[f.name] = f; }
        sync();
    };

    function sync() { if (conn?.open) conn.send({ type: 'list', files: Object.values(myFiles).map(f => ({name: f.name, size: f.size})) }); }

    function renderList(files) {
        const ui = document.getElementById('peerFiles'); ui.innerHTML = "<b>Available:</b>";
        files.forEach(f => {
            ui.innerHTML += `<div style="display:flex; justify-content:space-between; margin-top:10px;">
                <span style="font-size:0.9rem">${f.name}</span>
                <button onclick="conn.send({type:'req', name:'${f.name}'})" style="cursor:pointer; background:none; border:1px solid var(--p); color:var(--p); padding:2px 8px; border-radius:4px;">GET</button>
            </div>`;
        });
    }

    // --- STRICT BINARY SENDING ---
    async function sendFile(name) {
        const file = myFiles[name];
        updateUI(name, 'SENDING');
        conn.send({ type: 'meta', name: file.name, size: file.size });

        const buffer = await file.arrayBuffer();
        let offset = 0;

        while (offset < file.size) {
            // BACKPRESSURE: Pause if buffer is full
            if (conn.dataChannel.bufferedAmount > 1000000) {
                await new Promise(r => setTimeout(r, 30));
                continue;
            }

            const chunk = buffer.slice(offset, offset + CHUNK_SIZE);
            conn.send(chunk); // Send raw binary slice
            offset += CHUNK_SIZE;
            
            const p = Math.floor((offset / file.size) * 100);
            document.getElementById('bar').value = p;
            document.getElementById('perc').innerText = p + "%";
        }
        document.getElementById('mode').innerText = "SENT ✅";
    }

    // --- STRICT BINARY RECEIVING ---
    function receiveFile(meta) {
        updateUI(meta.name, 'RECEIVING');
        let receivedSize = 0;
        let fileParts = [];

        const onData = (data) => {
            if (data.type) return; // Ignore control messages

            fileParts.push(data);
            receivedSize += data.byteLength;
            
            const p = Math.min(100, Math.floor((receivedSize / meta.size) * 100));
            document.getElementById('bar').value = p;
            document.getElementById('perc').innerText = p + "%";

            if (receivedSize >= meta.size) {
                conn.off('data', onData);
                const blob = new Blob(fileParts, { type: 'application/octet-stream' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = meta.name; a.click();
                document.getElementById('mode').innerText = "SAVED ✅";
                fileParts = []; // Clear RAM
            }
        };
        conn.on('data', onData);
    }

    function updateUI(name, mode) {
        document.getElementById('monitor').style.display = 'block';
        document.getElementById('fname').innerText = name;
        document.getElementById('mode').innerText = mode;
    }
</script>
</body>
</html>

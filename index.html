<!DOCTYPE html>
<html>
<head>
    <title>IPFS P2P Room Storage</title>
    <script type="module">
        // Importing Helia (Modern IPFS for Browser)
        import { createHelia } from 'https://esm.sh/helia';
        import { unixfs } from 'https://esm.sh/@helia/unixfs';
        import { strings } from 'https://esm.sh/@helia/strings';

        let helia, fs, s;
        const fileList = document.getElementById('fileList');
        const status = document.getElementById('status');

        async function initIPFS() {
            status.innerText = "ðŸŒ€ Booting IPFS Node...";
            helia = await createHelia();
            fs = unixfs(helia);
            s = strings(helia);
            
            status.innerText = "ðŸŒ Node Online. Waiting for files...";
            setupRoom();
        }

        // 1. Room Logic (PubSub)
        // Note: For a true room without a server, we use a specific 'topic'
        const topic = window.location.hash || "#global-lobby";

        async function setupRoom() {
            // We subscribe to the room topic
            await helia.libp2p.services.pubsub.subscribe(topic);
            
            helia.libp2p.services.pubsub.addEventListener('message', (evt) => {
                const data = JSON.parse(new TextDecoder().decode(evt.detail.data));
                addFileToList(data.name, data.cid, data.size);
            });
        }

        // 2. Upload to IPFS
        window.uploadFile = async () => {
            const file = document.getElementById('fileInput').files[0];
            if (!file) return;

            status.innerText = "ðŸ“¤ Uploading to IPFS Network...";
            const bytes = new Uint8Array(await file.arrayBuffer());
            const cid = await fs.addBytes(bytes);

            const fileData = {
                name: file.name,
                cid: cid.toString(),
                size: (file.size / 1024 / 1024).toFixed(2) + " MB"
            };

            // Broadcast the file info to everyone in the room
            const msg = new TextEncoder().encode(JSON.stringify(fileData));
            await helia.libp2p.services.pubsub.publish(topic, msg);

            addFileToList(fileData.name, fileData.cid, fileData.size);
            status.innerText = "âœ… File Broadcasted!";
        };

        // 3. Download from IPFS
        window.downloadFile = async (cid, name) => {
            status.innerText = "ðŸ“¥ Fetching from IPFS peers...";
            const chunks = [];
            for await (const chunk of fs.cat(cid)) {
                chunks.push(chunk);
            }
            const blob = new Blob(chunks);
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = name;
            a.click();
            status.innerText = "ðŸŽ‰ Download Complete!";
        };

        function addFileToList(name, cid, size) {
            // Check if already in list
            if (document.getElementById(cid)) return;

            const li = document.createElement('li');
            li.id = cid;
            li.innerHTML = `
                <strong>${name}</strong> (${size}) <br>
                <small>${cid}</small> <br>
                <button onclick="downloadFile('${cid}', '${name}')">Download</button>
                <hr>
            `;
            fileList.appendChild(li);
        }

        initIPFS();
    </script>
    <style>
        body { font-family: sans-serif; max-width: 500px; margin: auto; padding: 20px; background: #f4f4f4; }
        .box { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        #fileList { list-style: none; padding: 0; margin-top: 20px; }
        button { background: #007bff; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; }
        #status { font-size: 0.8rem; color: #666; margin-bottom: 10px; }
    </style>
</head>
<body>
    <div class="box">
        <h2>ðŸ“¦ IPFS Room</h2>
        <div id="status">Loading libraries...</div>
        
        <input type="file" id="fileInput">
        <button onclick="uploadFile()">Upload & Share</button>

        <h3>Available Files</h3>
        <ul id="fileList"></ul>
    </div>
</body>
</html>

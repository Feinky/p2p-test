<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Titan P2P | Stable Sync</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --p: #1a9fff; --bg: #0b0e14; --card: #1c1c1e; --text: #ffffff; --success: #4c6b22; }
        body { font-family: system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; height: 100vh; }
        header { background: #000; padding: 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--p); }
        main { display: grid; grid-template-columns: 1fr 1fr; gap: 2px; flex-grow: 1; background: #2c2c2e; overflow: hidden; }
        .panel { background: var(--card); padding: 20px; display: flex; flex-direction: column; overflow: hidden; }
        .file-list { flex-grow: 1; overflow-y: auto; background: rgba(0,0,0,0.2); border-radius: 8px; margin-top: 10px; }
        #monitor { background: #171a21; border-top: 1px solid #333; min-height: 140px; padding: 15px; overflow-y: auto; }
        .transfer-item { display: grid; grid-template-columns: 100px 1fr 80px; align-items: center; gap: 15px; background: rgba(255,255,255,0.03); padding: 10px; border-radius: 4px; margin-bottom: 5px; }
        progress { width: 100%; height: 12px; accent-color: var(--p); }
        .btn { background: var(--p); color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .log-msg { font-size: 0.7rem; color: #888; font-family: monospace; }
    </style>
</head>
<body>

<header>
    <div style="font-weight: 900;">TITAN P2P</div>
    <div style="display:flex; gap:10px;">
        <input type="text" id="roomIn" placeholder="Room Name..." style="background:#222; border:1px solid #444; color:white; padding:5px;">
        <button class="btn" onclick="init()">CONNECT</button>
    </div>
</header>

<main>
    <div class="panel">
        <button class="btn" style="background:var(--success)" onclick="document.getElementById('picker').click()">+ ADD FILE</button>
        <input type="file" id="picker" multiple style="display:none">
        <div id="myFiles" class="file-list"></div>
    </div>
    <div class="panel">
        <div id="peerFiles" class="file-list"></div>
        <div id="logs" class="log-msg" style="margin-top:10px; height: 40px; overflow: hidden;">System Ready...</div>
    </div>
</main>

<div id="monitor">
    <div id="transferContainer"></div>
</div>

<script>
    let peer, conn, myFiles = {};

    function log(msg) { document.getElementById('logs').innerText = "> " + msg; }

    function init() {
        const room = document.getElementById('roomIn').value.trim();
        if (!room) return;
        if (peer) peer.destroy();
        
        // Use Google STUN to bypass firewalls
        const cfg = { config: {'iceServers': [{ 'urls': 'stun:stun.l.google.com:19302' }] }};
        peer = new Peer(`TITAN-${room}-A`, cfg);

        peer.on('error', (err) => {
            if (err.type === 'unavailable-id') {
                peer = new Peer(`TITAN-${room}-B`, cfg);
                setupPeer(`TITAN-${room}-A`);
            } else { log("Error: " + err.type); }
        });
        peer.on('open', () => { log("Room Joined"); setupPeer(`TITAN-${room}-B`); });
    }

    function setupPeer(target) {
        peer.on('connection', c => handle(c));
        setInterval(() => { if(!conn || !conn.open) handle(peer.connect(target)); }, 3000);
    }

    function handle(c) {
        if (conn && conn.open) return;
        conn = c;
        conn.on('open', () => { log("Peer Connected"); sync(); });
        conn.on('data', data => {
            if (data.type === 'list') renderPeerFiles(data.files);
            if (data.type === 'req') startUpload(data.name);
            if (data.type === 'meta') startDownload(data);
            if (data.type === 'ack') log("Peer received: " + data.name);
        });
    }

    document.getElementById('picker').onchange = (e) => {
        for (let f of e.target.files) {
            myFiles[f.name] = f;
            document.getElementById('myFiles').innerHTML += `<div style="padding:8px; border-bottom:1px solid #333">${f.name}</div>`;
        }
        sync();
    };

    function sync() { if (conn?.open) conn.send({ type: 'list', files: Object.values(myFiles).map(f => ({ name: f.name, size: f.size })) }); }

    function renderPeerFiles(files) {
        const ui = document.getElementById('peerFiles'); ui.innerHTML = "";
        files.forEach(f => {
            const row = document.createElement('div');
            row.style = "display:flex; justify-content:space-between; padding:8px; border-bottom:1px solid #333";
            row.innerHTML = `<span>${f.name}</span> <button class="btn" style="padding:2px 8px; font-size:0.7rem" onclick="conn.send({type:'req', name:'${f.name}'})">GET</button>`;
            ui.appendChild(row);
        });
    }

    // --- FIXED UPLOAD WITH BACKPRESSURE ---
    async function startUpload(name) {
        const file = myFiles[name];
        const tid = Math.random().toString(36).substr(2, 5);
        createRow(tid, file.name, 'UPLOADING');
        
        conn.send({ type: 'meta', name: file.name, size: file.size, tid: tid });

        const reader = file.stream().getReader();
        let sent = 0;
        while (true) {
            // BACKPRESSURE: If outgoing buffer is > 1MB, wait!
            if (conn.dataChannel.bufferedAmount > 1000000) {
                await new Promise(r => setTimeout(r, 40)); 
                continue;
            }
            const { done, value } = await reader.read();
            if (done) break;
            conn.send(value);
            sent += value.length;
            updateUI(tid, sent, file.size);
        }
    }

    // --- FIXED DOWNLOAD ---
    function startDownload(meta) {
        createRow(meta.tid, meta.name, 'RECEIVING');
        let received = 0;
        let packages = [];

        const onData = (data) => {
            if (data.type) return; 
            packages.push(data);
            received += data.byteLength;
            updateUI(meta.tid, received, meta.size);

            if (received >= meta.size) {
                conn.off('data', onData); // Stop listening to file chunks
                const blob = new Blob(packages);
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = meta.name;
                a.click();
                document.getElementById(`tag-${meta.tid}`).innerText = "COMPLETE";
                conn.send({ type: 'ack', name: meta.name });
            }
        };
        conn.on('data', onData);
    }

    function createRow(id, name, type) {
        const container = document.getElementById('transferContainer');
        container.innerHTML = `
            <div class="transfer-item" id="row-${id}">
                <div id="tag-${id}" style="font-size:10px; font-weight:bold; color:var(--p)">${type}</div>
                <progress id="bar-${id}" value="0" max="100"></progress>
                <div id="perc-${id}" style="font-size:11px; text-align:right;">0%</div>
            </div>
        ` + container.innerHTML;
    }

    function updateUI(id, curr, total) {
        const p = Math.floor((curr / total) * 100);
        if(document.getElementById(`bar-${id}`)) document.getElementById(`bar-${id}`).value = p;
        if(document.getElementById(`perc-${id}`)) document.getElementById(`perc-${id}`).innerText = p + "%";
    }
</script>
</body>
</html>

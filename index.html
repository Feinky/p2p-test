<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Titan P2P Dashboard</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --p: #6366f1; --bg: #0b0e14; --card: #18181b; --text: #f4f4f5; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; height: 100vh; }
        
        /* Persistent Header */
        header { background: var(--card); padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #27272a; }
        .room-nav { display: flex; gap: 10px; align-items: center; }
        .badge { background: #27272a; padding: 5px 12px; border-radius: 15px; font-size: 0.8rem; color: var(--p); border: 1px solid var(--p); }
        
        /* Main Dashboard */
        main { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; padding: 20px; flex-grow: 1; overflow: hidden; }
        .panel { background: var(--card); border-radius: 16px; padding: 20px; display: flex; flex-direction: column; border: 1px solid #27272a; }
        .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        
        /* File List Styles */
        .list { flex-grow: 1; overflow-y: auto; background: rgba(0,0,0,0.2); border-radius: 10px; padding: 10px; }
        .item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #27272a; font-size: 0.9rem; }
        
        /* Interaction */
        button { background: var(--p); color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; }
        button.sec { background: transparent; border: 1px solid #3f3f46; }
        input[type="text"] { background: #0b0e14; border: 1px solid #3f3f46; color: white; padding: 8px; border-radius: 8px; }
        
        /* Progress Overlay */
        #transfer-status { position: fixed; bottom: 20px; right: 20px; background: var(--p); padding: 15px; border-radius: 12px; display: none; width: 300px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        progress { width: 100%; height: 8px; accent-color: white; }
    </style>
</head>
<body>

<header>
    <div style="font-weight: 800; font-size: 1.2rem; color: var(--p);">TITAN P2P</div>
    <div class="room-nav">
        <span id="room-display" class="badge">Not Connected</span>
        <input type="text" id="roomInput" placeholder="Room Name...">
        <button onclick="switchRoom()">Switch Room</button>
    </div>
</header>

<main>
    <div class="panel">
        <div class="panel-header">
            <h3>My Shared Files</h3>
            <button onclick="document.getElementById('filePicker').click()">+ Add File</button>
            <input type="file" id="filePicker" multiple style="display:none">
        </div>
        <div id="my-files" class="list"></div>
    </div>

    <div class="panel">
        <div class="panel-header">
            <h3>Available to Download</h3>
            <span id="peer-status" style="font-size: 0.8rem; color: #71717a;">Offline</span>
        </div>
        <div id="peer-files" class="list"></div>
    </div>
</main>

<div id="transfer-status">
    <div style="font-size: 0.8rem; margin-bottom: 5px;" id="filename-display">Transferring...</div>
    <progress id="progBar" value="0" max="100"></progress>
    <div style="text-align: right; font-size: 0.7rem;" id="percent-display">0%</div>
</div>

<script>
    let peer, conn, myFiles = {}, roomName = "";

    // 1. Symmetric Peer Logic
    async function switchRoom() {
        roomName = document.getElementById('roomInput').value.trim();
        if (!roomName) return;
        window.location.hash = roomName;
        document.getElementById('room-display').innerText = "Room: " + roomName;

        // Symmetric Discovery: Try to be 'A', if taken, be 'B'
        if (peer) peer.destroy();
        
        // We attempt to register as 'A'. If it fails, we catch error and register as 'B'.
        peer = new Peer("TITAN-" + roomName + "-A");

        peer.on('error', (err) => {
            if (err.type === 'unavailable-id') {
                peer = new Peer("TITAN-" + roomName + "-B");
                setupPeerEvents("TITAN-" + roomName + "-A");
            }
        });

        peer.on('open', () => {
            setupPeerEvents("TITAN-" + roomName + "-B");
        });
    }

    function setupPeerEvents(targetID) {
        peer.on('connection', (c) => handleConnection(c));
        
        // Repeatedly try to find the other person in the room
        const connectLoop = setInterval(() => {
            if (conn && conn.open) return clearInterval(connectLoop);
            const c = peer.connect(targetID);
            handleConnection(c);
        }, 3000);
    }

    function handleConnection(c) {
        conn = c;
        conn.on('open', () => {
            document.getElementById('peer-status').innerText = "Connected to Peer";
            document.getElementById('peer-status').style.color = "#10b981";
            // Send current manifest to the peer
            broadcastManifest();
        });

        conn.on('data', async (data) => {
            if (data.type === 'manifest') updatePeerList(data.files);
            if (data.type === 'request') streamFileToPeer(data.name);
            if (data.type === 'meta') receiveFileStream(data);
        });
        
        conn.on('close', () => {
            document.getElementById('peer-status').innerText = "Peer Disconnected";
            document.getElementById('peer-status').style.color = "#ef4444";
        });
    }

    // 2. Hosting / Sharing Logic
    document.getElementById('filePicker').onchange = (e) => {
        for (let f of e.target.files) {
            myFiles[f.name] = f;
            const item = document.createElement('div');
            item.className = 'item';
            item.innerHTML = `<span>${f.name}</span><small>${(f.size/1024/1024).toFixed(2)}MB</small>`;
            document.getElementById('my-files').appendChild(item);
        }
        broadcastManifest();
    };

    function broadcastManifest() {
        if (conn && conn.open) {
            const list = Object.values(myFiles).map(f => ({ name: f.name, size: f.size }));
            conn.send({ type: 'manifest', files: list });
        }
    }

    // 3. Downloading / Request Logic
    function updatePeerList(files) {
        const listUI = document.getElementById('peer-files');
        listUI.innerHTML = "";
        files.forEach(f => {
            const item = document.createElement('div');
            item.className = 'item';
            item.innerHTML = `<span>${f.name}</span><button onclick="requestFile('${f.name}')">Download</button>`;
            listUI.appendChild(item);
        });
    }

    function requestFile(name) {
        conn.send({ type: 'request', name: name });
    }

    // 4. Heavy Streaming Logic (1GB+)
    async function streamFileToPeer(name) {
        const file = myFiles[name];
        conn.send({ type: 'meta', name: file.name, size: file.size });
        const reader = file.stream().getReader();
        while (true) {
            if (conn.dataChannel.bufferedAmount > 1000000) {
                await new Promise(r => setTimeout(r, 50));
                continue;
            }
            const { done, value } = await reader.read();
            if (done) break;
            conn.send(value);
        }
    }

    async function receiveFileStream(meta) {
        const handle = await window.showSaveFilePicker({ suggestedName: meta.name });
        const writable = await handle.createWritable();
        let received = 0;
        
        document.getElementById('transfer-status').style.display = 'block';
        document.getElementById('filename-display').innerText = "Receiving: " + meta.name;

        conn.on('data', async (chunk) => {
            if (chunk.type) return; 
            await writable.write(chunk);
            received += chunk.byteLength;
            const p = Math.floor((received / meta.size) * 100);
            document.getElementById('progBar').value = p;
            document.getElementById('percent-display').innerText = p + "%";
            
            if (received >= meta.size) {
                await writable.close();
                document.getElementById('transfer-status').style.display = 'none';
            }
        });
    }

    // Handle Auto-Join via URL Hash
    if(window.location.hash) {
        document.getElementById('roomInput').value = window.location.hash.substring(1);
        switchRoom();
    }
</script>
</body>
</html>

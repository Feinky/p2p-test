<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Titan Transfer | Multi-File P2P</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --primary: #6366f1; --bg: #0f172a; --card: rgba(30, 41, 59, 0.8); --text: #f8fafc; }
        body { font-family: 'Inter', sans-serif; background: #0b0e14; color: var(--text); display: flex; align-items: center; justify-content: center; min-height: 100vh; margin: 0; }
        .glass-card { background: var(--card); backdrop-filter: blur(15px); padding: 2rem; border-radius: 20px; width: 450px; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .status-bar { display: flex; justify-content: space-between; font-size: 0.75rem; margin-bottom: 1rem; color: #94a3b8; }
        .badge { padding: 4px 10px; border-radius: 20px; background: rgba(99, 102, 241, 0.2); color: var(--primary); font-weight: bold; }
        input[type="text"] { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #334155; background: #0f172a; color: white; margin-bottom: 1rem; box-sizing: border-box; }
        .file-list { margin-top: 1rem; background: rgba(0,0,0,0.2); border-radius: 10px; max-height: 200px; overflow-y: auto; }
        .file-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 0.9rem; }
        .btn { width: 100%; padding: 12px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; margin-top: 5px; }
        .btn-p { background: var(--primary); color: white; }
        .btn-s { background: #10b981; color: white; padding: 5px 12px; width: auto; font-size: 0.8rem; }
        progress { width: 100%; height: 8px; border-radius: 10px; margin: 10px 0; accent-color: var(--primary); }
    </style>
</head>
<body>

<div class="glass-card">
    <div class="status-bar">
        <span id="conn-count">Disconnected</span>
        <span class="badge" id="room-id">No Room</span>
    </div>

    <input type="text" id="roomInput" placeholder="Enter Room Name (e.g. MySecretFiles)">
    
    <div id="setup-area">
        <button class="btn btn-p" onclick="initNode()">Enter Room</button>
    </div>

    <div id="main-area" style="display:none">
        <input type="file" id="filePicker" multiple style="display:none">
        <button class="btn btn-p" onclick="document.getElementById('filePicker').click()">âž• Add Files to Room</button>
        
        <div class="file-list" id="fileList">
            </div>
    </div>

    <div id="transfer-ui" style="display:none; margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #334155;">
        <div style="display:flex; justify-content: space-between; font-size: 0.8rem;">
            <span id="active-file">...</span>
            <span id="active-percent">0%</span>
        </div>
        <progress id="progBar" value="0" max="100"></progress>
    </div>
</div>

<script>
    let peer, connections = [], hostedFiles = {};

    function initNode() {
        const room = document.getElementById('roomInput').value.trim();
        if (!room) return;
        
        peer = new Peer("TITAN-" + room);
        
        peer.on('open', (id) => {
            document.getElementById('room-id').innerText = room;
            document.getElementById('setup-area').style.display = 'none';
            document.getElementById('main-area').style.display = 'block';
            document.getElementById('conn-count').innerText = "Waiting for peers...";
        });

        // When someone connects to you
        peer.on('connection', (conn) => {
            setupConnection(conn);
        });

        // Auto-connect to existing host if it exists
        const conn = peer.connect("TITAN-" + room);
        setupConnection(conn);
    }

    function setupConnection(conn) {
        conn.on('open', () => {
            connections.push(conn);
            document.getElementById('conn-count').innerText = connections.length + " Peer(s) Connected";
            
            // If we have files already, tell the newcomer
            if (Object.keys(hostedFiles).length > 0) {
                conn.send({ type: 'manifest', files: Object.values(hostedFiles).map(f => ({name: f.name, size: f.size, id: f.name})) });
            }
        });

        conn.on('data', (data) => {
            if (data.type === 'manifest') {
                displayManifest(data.files, conn);
            } else if (data.type === 'request') {
                sendFileToPeer(data.fileID, conn);
            } else if (data.type === 'meta') {
                startReceiverStream(data, conn);
            }
        });
    }

    // HOST SIDE: Pick files and announce them
    document.getElementById('filePicker').onchange = (e) => {
        const files = e.target.files;
        for (let f of files) {
            hostedFiles[f.name] = f;
            addToFileUI(f.name, (f.size / 1024 / 1024).toFixed(2) + "MB", true);
        }
        // Broadcast new list to everyone
        const manifest = Object.values(hostedFiles).map(f => ({name: f.name, size: f.size, id: f.name}));
        connections.forEach(c => c.send({ type: 'manifest', files: manifest }));
    };

    function addToFileUI(name, size, isHost) {
        const item = document.createElement('div');
        item.className = 'file-item';
        item.innerHTML = `<span>${name} (${size})</span>` + 
            (isHost ? `<span style="color:#94a3b8">Hosted</span>` : `<button class="btn-s" onclick="requestDownload('${name}')">Download</button>`);
        document.getElementById('fileList').appendChild(item);
    }

    // RECEIVER SIDE: Show what files are available
    function displayManifest(files, conn) {
        const list = document.getElementById('fileList');
        list.innerHTML = "";
        files.forEach(f => {
            const item = document.createElement('div');
            item.className = 'file-item';
            item.innerHTML = `<span>${f.name}</span> <button class="btn-s" onclick="requestDownload('${f.name}')">Download</button>`;
            list.appendChild(item);
        });
    }

    let currentActiveConn; 
    function requestDownload(name) {
        // Find which connection has this file (simplification: using first connection)
        connections[0].send({ type: 'request', fileID: name });
    }

    async function sendFileToPeer(name, conn) {
        const file = hostedFiles[name];
        conn.send({ type: 'meta', name: file.name, size: file.size });
        const reader = file.stream().getReader();
        while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            conn.send(value);
        }
    }

    async function startReceiverStream(meta, conn) {
        const handle = await window.showSaveFilePicker({ suggestedName: meta.name });
        const writable = await handle.createWritable();
        let received = 0;
        document.getElementById('transfer-ui').style.display = 'block';
        document.getElementById('active-file').innerText = meta.name;

        conn.on('data', async (chunk) => {
            if (chunk.type) return; // Skip manifest/meta
            await writable.write(chunk);
            received += chunk.byteLength;
            const p = Math.floor((received / meta.size) * 100);
            document.getElementById('progBar').value = p;
            document.getElementById('active-percent').innerText = p + "%";
            if (received >= meta.size) await writable.close();
        });
    }
</script>
</body>
</html>

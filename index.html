<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Titan P2P | Steam Style</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --p: #1a9fff; --bg: #171a21; --card: #1b2838; --text: #c7d5e0; --success: #4c6b22; }
        body { font-family: "Motiva Sans", Sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* Header */
        header { background: #000; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--p); }
        .room-controls { display: flex; gap: 10px; }
        input { background: #32353c; border: none; color: white; padding: 8px; border-radius: 4px; }
        
        /* Layout */
        main { display: grid; grid-template-columns: 1fr 1fr; gap: 2px; flex-grow: 1; background: #000; overflow: hidden; }
        .panel { background: var(--card); padding: 20px; display: flex; flex-direction: column; }
        .list { flex-grow: 1; overflow-y: auto; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 4px; }
        .item { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(255,255,255,0.05); margin-bottom: 5px; border-radius: 4px; }

        /* Transfer Manager (Steam Style) */
        #transfer-manager { background: #171a21; border-top: 1px solid #333; height: 180px; padding: 15px 30px; display: flex; flex-direction: column; gap: 10px; }
        .transfer-row { display: grid; grid-template-columns: 150px 1fr 100px; align-items: center; gap: 20px; background: rgba(255,255,255,0.03); padding: 10px; border-radius: 4px; }
        .type-tag { font-size: 10px; font-weight: bold; text-transform: uppercase; padding: 2px 6px; border-radius: 3px; width: fit-content; }
        .up { background: var(--p); color: white; }
        .down { background: var(--success); color: white; }
        
        progress { width: 100%; height: 12px; accent-color: var(--p); background: #3d4450; border: none; border-radius: 2px; }
        button { background: #3d4450; color: #fff; border: none; padding: 8px 15px; border-radius: 2px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        button:hover { background: var(--p); }
        .btn-add { background: var(--success); }
    </style>
</head>
<body>

<header>
    <div style="font-size: 1.5rem; font-weight: bold; letter-spacing: 2px;">TITAN <span style="color:var(--p)">P2P</span></div>
    <div class="room-controls">
        <input type="text" id="roomInput" placeholder="Room ID...">
        <button onclick="joinRoom()">SWITCH ROOM</button>
    </div>
</header>

<main>
    <div class="panel">
        <h3>LIBRARY (MY FILES)</h3>
        <button class="btn-add" onclick="document.getElementById('filePicker').click()">+ ADD FILE TO ROOM</button>
        <input type="file" id="filePicker" multiple style="display:none">
        <div id="my-files" class="list" style="margin-top:15px"></div>
    </div>
    <div class="panel">
        <h3>REMOTE (PEER FILES)</h3>
        <div id="peer-files" class="list"></div>
    </div>
</main>

<div id="transfer-manager">
    <div style="font-weight: bold; color: #66c0f4; font-size: 0.8rem; letter-spacing: 1px;">ACTIVE TRANSFERS</div>
    <div id="transfer-list" style="overflow-y: auto;">
        </div>
</div>

<script>
    let peer, conn, myFiles = {}, roomID = "";

    function joinRoom() {
        roomID = document.getElementById('roomInput').value.trim();
        if (!roomID) return;
        window.location.hash = roomID;

        if (peer) peer.destroy();
        
        // Symmetric logic: try A, fallback to B
        peer = new Peer(`TITAN-GIGA-${roomID}-A`);
        peer.on('error', (err) => {
            if (err.type === 'unavailable-id') {
                peer = new Peer(`TITAN-GIGA-${roomID}-B`);
                setupEvents(`TITAN-GIGA-${roomID}-A`);
            }
        });
        peer.on('open', () => setupEvents(`TITAN-GIGA-${roomID}-B`));
    }

    function setupEvents(target) {
        peer.on('connection', c => handleConn(c));
        const retry = setInterval(() => {
            if (conn && conn.open) return clearInterval(retry);
            handleConn(peer.connect(target));
        }, 3000);
    }

    function handleConn(c) {
        conn = c;
        conn.on('open', () => broadcastManifest());
        conn.on('data', data => {
            if (data.type === 'manifest') updatePeerUI(data.files);
            if (data.type === 'request') startUpload(data.name);
            if (data.type === 'meta') startDownload(data);
        });
    }

    // --- LOGIC ---
    document.getElementById('filePicker').onchange = (e) => {
        for (let f of e.target.files) {
            myFiles[f.name] = f;
            const div = document.createElement('div');
            div.className = 'item';
            div.innerHTML = `<span>${f.name}</span><small>${(f.size/1e6).toFixed(1)}MB</small>`;
            document.getElementById('my-files').appendChild(div);
        }
        broadcastManifest();
    };

    function broadcastManifest() {
        if (conn?.open) {
            const list = Object.values(myFiles).map(f => ({ name: f.name, size: f.size }));
            conn.send({ type: 'manifest', files: list });
        }
    }

    function updatePeerUI(files) {
        const ui = document.getElementById('peer-files');
        ui.innerHTML = "";
        files.forEach(f => {
            const div = document.createElement('div');
            div.className = 'item';
            div.innerHTML = `<span>${f.name}</span><button onclick="conn.send({type:'request', name:'${f.name}'})">DOWNLOAD</button>`;
            ui.appendChild(div);
        });
    }

    // --- STEAM-STYLE UI UPDATER ---
    function createTransferRow(id, name, type) {
        const row = document.createElement('div');
        row.id = `row-${id}`;
        row.className = 'transfer-row';
        row.innerHTML = `
            <div>
                <div class="type-tag ${type}">${type}ING</div>
                <div style="font-size:11px; margin-top:4px; overflow:hidden; white-space:nowrap;">${name}</div>
            </div>
            <progress id="prog-${id}" value="0" max="100"></progress>
            <div id="perc-${id}" style="font-size:12px; text-align:right;">0%</div>
        `;
        document.getElementById('transfer-list').prepend(row);
        return row;
    }

    async function startUpload(name) {
        const file = myFiles[name];
        const id = Math.random().toString(36).substr(2, 5);
        createTransferRow(id, name, 'upload');
        
        conn.send({ type: 'meta', name: file.name, size: file.size });
        const reader = file.stream().getReader();
        let sent = 0;
        
        while (true) {
            if (conn.dataChannel.bufferedAmount > 1e6) { await new Promise(r => setTimeout(r, 50)); continue; }
            const { done, value } = await reader.read();
            if (done) break;
            conn.send(value);
            sent += value.length;
            updateProgress(id, sent, file.size);
        }
        document.getElementById(`row-${id}`).style.opacity = "0.5";
    }

    async function startDownload(meta) {
        const handle = await window.showSaveFilePicker({ suggestedName: meta.name });
        const writable = await handle.createWritable();
        const id = Math.random().toString(36).substr(2, 5);
        createTransferRow(id, meta.name, 'download');

        let received = 0;
        conn.on('data', async (chunk) => {
            if (chunk.type) return;
            await writable.write(chunk);
            received += chunk.byteLength;
            updateProgress(id, received, meta.size);
            if (received >= meta.size) {
                await writable.close();
                document.getElementById(`row-${id}`).style.opacity = "0.5";
            }
        });
    }

    function updateProgress(id, curr, total) {
        const p = Math.floor((curr / total) * 100);
        const bar = document.getElementById(`prog-${id}`);
        const text = document.getElementById(`perc-${id}`);
        if(bar) bar.value = p;
        if(text) text.innerText = p + "%";
    }

    if(window.location.hash) {
        document.getElementById('roomInput').value = window.location.hash.substring(1);
        joinRoom();
    }
</script>
</body>
</html>

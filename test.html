<!DOCTYPE html>
<html>
<head><title>P2P File Test</title></head>
<body>
<input type="file" id="fileInput"><button onclick="sendFile()">Send</button>
<div id="status"></div>
<div id="progress"></div>
<script>
const pc = new RTCPeerConnection({iceServers:[{urls:'stun:stun.l.google.com:19302'}]});
let channel, file, chunks = [];

pc.ondatachannel = e => {
  channel = e.channel;
  channel.onmessage = e => receiveChunk(e.data);
  document.getElementById('status').innerHTML = 'Connected! Ready to receive.';
};

function sendFile() {
  file = document.getElementById('fileInput').files[0];
  channel = pc.createDataChannel('file');
  channel.onopen = () => sendChunks();
  pc.createOffer().then(offer => {
    pc.setLocalDescription(offer);
    console.log('OFFER:', btoa(JSON.stringify(offer))); // Copy this
  });
}

function sendChunks() {
  const chunkSize = 16384;
  let offset = 0;
  channel.send(JSON.stringify({name:file.name, size:file.size})); // metadata
  function next() {
    const reader = new FileReader();
    reader.onload = e => {
      channel.send(e.target.result);
      offset += chunkSize;
      if(offset < file.size) next();
    };
    reader.readAsArrayBuffer(file.slice(offset, offset+chunkSize));
  }
  next();
}

function receiveChunk(data) {
  const dataStr = new TextDecoder().decode(data);
  if(!file && dataStr.startsWith('{')) {
    const meta = JSON.parse(dataStr);
    file = new Blob([], {type:'application/octet-stream'});
    chunks = [];
    document.getElementById('status').innerHTML = `Receiving ${meta.name} (${meta.size} bytes)`;
    return;
  }
  chunks.push(data);
  document.getElementById('progress').innerHTML = `${chunks.length*16}KB received`;
  if(chunks.reduce((a,b)=>a+b.byteLength,0) >= file.size) {
    download(new Blob(chunks));
  }
}

function download(blob) {
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = file.name;
  a.click();
  document.getElementById('status').innerHTML = 'âœ… File received!';
}

// RECEIVER: Paste OFFER from sender console here:
function connect(offerStr) {
  const offer = JSON.parse(atob(offerStr));
  pc.setRemoteDescription(offer).then(()=>pc.createAnswer()).then(answer=>{
    pc.setLocalDescription(answer);
    console.log('ANSWER:', btoa(JSON.stringify(answer))); // Copy back to sender
  });
}
</script>
<button onclick="connect(prompt('Paste OFFER from sender console'))">Connect as Receiver</button>
</body>
</html>
